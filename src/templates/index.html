<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Automation Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-card {
            transition: all 0.3s;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-ok {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .log-container {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .config-section {
            margin-bottom: 20px;
        }
        .config-section h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .nav-pills .nav-link {
            color: #495057;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .tab-content {
            background-color: white;
            padding: 25px;
            border-radius: 0 5px 5px 5px;
            border: 1px solid #dee2e6;
        }
        .nav-pills {
            margin-bottom: -1px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-gear-fill"></i> Order Automation Manager
            </h1>
            <button class="btn btn-outline-primary" id="refresh-status-btn">
                <i class="bi bi-arrow-clockwise"></i> Refresh Status
            </button>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-browser-chrome"></i> Chrome Status
                        </h5>
                        <p class="card-text">
                            <span class="status-indicator" id="chrome-status"></span>
                            <span id="chrome-status-text">Checking...</span>
                        </p>
                        <small class="text-muted" id="system-info"></small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-box"></i> BaseLinker
                        </h5>
                        <p class="card-text">
                            <span class="status-indicator" id="baselinker-status"></span>
                            <span id="baselinker-status-text">Checking...</span>
                        </p>
                        <small class="text-muted" id="baselinker-title"></small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-shop"></i> B2B Hendi
                        </h5>
                        <p class="card-text">
                            <span class="status-indicator" id="b2b-status"></span>
                            <span id="b2b-status-text">Checking...</span>
                        </p>
                        <small class="text-muted" id="b2b-title"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-play-circle"></i> Actions
                </h5>
                <button class="btn btn-primary btn-lg" id="launch-chrome-btn">
                    <i class="bi bi-browser-chrome"></i> Launch Chrome
                </button>
                <button class="btn btn-warning btn-lg" id="extract-order-btn">
                    <i class="bi bi-download"></i> Extract Order Data
                </button>
                <button class="btn btn-success btn-lg" id="extract-and-import-btn">
                    <i class="bi bi-lightning-fill"></i> Extract & Import to B2B
                </button>
                <button class="btn btn-secondary btn-lg" id="config-btn">
                    <i class="bi bi-gear"></i> Configuration
                </button>
            </div>
        </div>

        <!-- Configuration Section with Tabs (hidden by default) -->
        <div class="card mb-4" id="config-section" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear-fill"></i> Advanced Configuration
                    </h5>
                    <div>
                        <button class="btn btn-primary" id="save-config-btn">
                            <i class="bi bi-save"></i> Save All
                        </button>
                        <button class="btn btn-secondary" id="cancel-config-btn">
                            <i class="bi bi-x-lg"></i> Cancel
                        </button>
                    </div>
                </div>

                <ul class="nav nav-pills mb-3" id="config-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="pill" data-bs-target="#general" type="button" role="tab">
                            <i class="bi bi-sliders"></i> General
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="baselinker-tab" data-bs-toggle="pill" data-bs-target="#baselinker" type="button" role="tab">
                            <i class="bi bi-box"></i> BaseLinker
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="b2b-tab" data-bs-toggle="pill" data-bs-target="#b2b" type="button" role="tab">
                            <i class="bi bi-shop"></i> B2B Hendi
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timing-tab" data-bs-toggle="pill" data-bs-target="#timing" type="button" role="tab">
                            <i class="bi bi-clock"></i> Timing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="processing-tab" data-bs-toggle="pill" data-bs-target="#processing" type="button" role="tab">
                            <i class="bi bi-cpu"></i> Processing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="pill" data-bs-target="#advanced" type="button" role="tab">
                            <i class="bi bi-wrench"></i> Advanced
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="config-tab-content">
                    <!-- General Tab -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-browser-chrome"></i> Chrome Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="chrome-path" class="form-label">Chrome Path</label>
                                        <input type="text" class="form-control" id="chrome-path" placeholder="Leave empty for auto-detect">
                                        <div class="form-text">Path to Chrome executable (optional)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="debug-port" class="form-label">Debug Port</label>
                                        <input type="number" class="form-control" id="debug-port" value="9222">
                                        <div class="form-text">Chrome remote debugging port</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="user-data-dir" class="form-label">User Data Directory</label>
                                <input type="text" class="form-control" id="user-data-dir">
                                <div class="form-text">Chrome profile directory for persistent login</div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-link-45deg"></i> URLs & Keywords</h6>
                            <div class="mb-3">
                                <label for="baselinker-url" class="form-label">BaseLinker URL</label>
                                <input type="text" class="form-control" id="baselinker-url">
                            </div>
                            <div class="mb-3">
                                <label for="b2b-url" class="form-label">B2B Hendi URL</label>
                                <input type="text" class="form-control" id="b2b-url">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="baselinker-keywords" class="form-label">BaseLinker Keywords</label>
                                        <input type="text" class="form-control" id="baselinker-keywords">
                                        <div class="form-text">Comma-separated</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="b2b-keywords" class="form-label">B2B Keywords</label>
                                        <input type="text" class="form-control" id="b2b-keywords">
                                        <div class="form-text">Comma-separated</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BaseLinker Tab -->
                    <div class="tab-pane fade" id="baselinker" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-code-square"></i> BaseLinker Selectors</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Products Container ID</label>
                                        <input type="text" class="form-control" id="bl-products-container">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Total Price ID</label>
                                        <input type="text" class="form-control" id="bl-total-price">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Paid Amount Selector</label>
                                        <input type="text" class="form-control" id="bl-paid-amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Phone ID</label>
                                        <input type="text" class="form-control" id="bl-phone">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email ID</label>
                                        <input type="text" class="form-control" id="bl-email">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">B2B Number Field ID</label>
                                        <input type="text" class="form-control" id="bl-b2b-field">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-pin-map"></i> Address Selectors</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Fullname ID</label>
                                        <input type="text" class="form-control" id="bl-addr-fullname">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Company ID</label>
                                        <input type="text" class="form-control" id="bl-addr-company">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Street ID</label>
                                        <input type="text" class="form-control" id="bl-addr-street">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">City ID</label>
                                        <input type="text" class="form-control" id="bl-addr-city">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Postcode ID</label>
                                        <input type="text" class="form-control" id="bl-addr-postcode">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-regex"></i> Regex Patterns</h6>
                            <div class="mb-3">
                                <label class="form-label">SKU Pattern</label>
                                <input type="text" class="form-control" id="bl-regex-sku">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quantity Pattern</label>
                                <input type="text" class="form-control" id="bl-regex-quantity">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Price Amount Pattern</label>
                                <input type="text" class="form-control" id="bl-regex-price">
                            </div>
                        </div>
                    </div>

                    <!-- B2B Hendi Tab -->
                    <div class="tab-pane fade" id="b2b" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-code-square"></i> B2B Selectors</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Order Settings Container</label>
                                        <input type="text" class="form-control" id="b2b-order-container">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Import Button</label>
                                        <input type="text" class="form-control" id="b2b-import-btn">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-card-checklist"></i> Order Process Buttons</h6>
                            <div class="mb-3">
                                <label class="form-label">Continue Button</label>
                                <input type="text" class="form-control" id="b2b-continue-btn">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Add to Cart Button</label>
                                <input type="text" class="form-control" id="b2b-add-cart-btn">
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-credit-card"></i> Payment Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Bank Transfer Value</label>
                                        <input type="text" class="form-control" id="b2b-payment-transfer">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Cash on Delivery Value</label>
                                        <input type="text" class="form-control" id="b2b-payment-cash">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-filetype-csv"></i> CSV Settings</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Delimiter</label>
                                        <input type="text" class="form-control" id="csv-delimiter" maxlength="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Encoding</label>
                                        <select class="form-select" id="csv-encoding">
                                            <option value="utf-8">UTF-8</option>
                                            <option value="iso-8859-1">ISO-8859-1</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">CSV Headers</label>
                                        <input type="text" class="form-control" id="csv-headers">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timing Tab -->
                    <div class="tab-pane fade" id="timing" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-stopwatch"></i> Timeout Settings (seconds)</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Default Timeout</label>
                                        <input type="number" class="form-control" id="timing-default" step="0.5" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Element Wait Timeout</label>
                                        <input type="number" class="form-control" id="timing-element" step="0.5" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-hourglass-split"></i> Delay Settings (seconds)</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">After Click</label>
                                        <input type="number" class="form-control" id="timing-click" step="0.1" min="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Between Steps</label>
                                        <input type="number" class="form-control" id="timing-steps" step="0.1" min="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Chrome Startup</label>
                                        <input type="number" class="form-control" id="timing-startup" step="0.1" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Tab -->
                    <div class="tab-pane fade" id="processing" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-scissors"></i> Data Processing Rules</h6>
                            <div class="mb-3">
                                <label class="form-label">Remove SKU Prefix</label>
                                <input type="text" class="form-control" id="proc-sku-prefix">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Remove Phone Prefix</label>
                                <input type="text" class="form-control" id="proc-phone-prefix">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Default Building Number</label>
                                <input type="text" class="form-control" id="proc-building">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Tab -->
                    <div class="tab-pane fade" id="advanced" role="tabpanel">
                        <div class="config-section">
                            <h6><i class="bi bi-toggles"></i> Advanced Options</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="opt-auto-detect">
                                <label class="form-check-label" for="opt-auto-detect">
                                    Auto-detect Chrome Host
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="opt-use-js">
                                <label class="form-check-label" for="opt-use-js">
                                    Use JavaScript for Form Filling
                                </label>
                            </div>
                        </div>

                        <div class="config-section">
                            <h6><i class="bi bi-journal-code"></i> Logging</h6>
                            <div class="mb-3">
                                <label class="form-label">Log Level</label>
                                <select class="form-select" id="log-level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Data Section (hidden by default) -->
        <div class="card mb-4" id="order-data-section" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-cart-check"></i> Order Data
                    <button class="btn btn-sm btn-outline-secondary float-end" id="close-order-data-btn">
                        <i class="bi bi-x"></i> Close
                    </button>
                </h5>

                <!-- Products -->
                <h6 class="mt-3">Products</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Quantity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-success" id="add-product-btn">
                        <i class="bi bi-plus"></i> Add Product
                    </button>
                </div>

                <!-- Contact & Address -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>Contact Information</h6>
                        <div class="mb-2">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control form-control-sm" id="order-phone">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control form-control-sm" id="order-email">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Payment Amount (PLN)</label>
                            <input type="text" class="form-control form-control-sm" id="order-payment" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Delivery Address</h6>
                        <div class="mb-2">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control form-control-sm" id="order-name">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control form-control-sm" id="order-company">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Street Address</label>
                            <input type="text" class="form-control form-control-sm" id="order-address">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control form-control-sm" id="order-city">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Postal Code</label>
                            <input type="text" class="form-control form-control-sm" id="order-postal-code">
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-success" id="import-to-b2b-btn">
                        <i class="bi bi-upload"></i> Import to B2B
                    </button>
                    <button class="btn btn-secondary" id="clear-order-btn">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-terminal"></i> Logs
                </h5>
                <div class="log-container" id="log-container">
                    <div>Waiting for actions...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inline JavaScript - wszystko w jednym pliku
        let statusInterval;
        let logsInterval;

        async function updateLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                if (data.logs && data.logs.length > 0) {
                    const logContainer = document.getElementById('log-container');
                    logContainer.innerHTML = '';
                    
                    data.logs.forEach(line => {
                        const logEntry = document.createElement('div');
                        logEntry.textContent = line.trim();
                        
                        if (line.includes('ERROR')) {
                            logEntry.style.color = '#ff6b6b';
                        } else if (line.includes('WARNING')) {
                            logEntry.style.color = '#ffd93d';
                        } else if (line.includes('SUCCESS')) {
                            logEntry.style.color = '#6bcf7f';
                        }
                        
                        logContainer.appendChild(logEntry);
                    });
                    
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('chrome-path').value = config.chrome_path || '';
                document.getElementById('user-data-dir').value = config.chrome_user_data_dir || '';
                document.getElementById('debug-port').value = config.chrome_debug_port || 9222;
                document.getElementById('baselinker-url').value = config.baselinker_url || '';
                document.getElementById('b2b-url').value = config.b2b_hendi_url || '';
                document.getElementById('baselinker-keywords').value = (config.baselinker_keywords || []).join(', ');
                document.getElementById('b2b-keywords').value = (config.b2b_keywords || []).join(', ');

                const blSel = config.baselinker_selectors || {};
                document.getElementById('bl-products-container').value = blSel.products_container || '';
                document.getElementById('bl-total-price').value = blSel.total_price || '';
                document.getElementById('bl-paid-amount').value = blSel.paid_amount || '';
                document.getElementById('bl-phone').value = blSel.phone || '';
                document.getElementById('bl-email').value = blSel.email || '';
                document.getElementById('bl-b2b-field').value = blSel.b2b_number_field || '';
                
                const blAddr = blSel.address || {};
                document.getElementById('bl-addr-fullname').value = blAddr.fullname || '';
                document.getElementById('bl-addr-company').value = blAddr.company || '';
                document.getElementById('bl-addr-street').value = blAddr.street || '';
                document.getElementById('bl-addr-city').value = blAddr.city || '';
                document.getElementById('bl-addr-postcode').value = blAddr.postcode || '';

                const blRegex = config.regex_patterns?.baselinker || {};
                document.getElementById('bl-regex-sku').value = blRegex.sku || '';
                document.getElementById('bl-regex-quantity').value = blRegex.quantity || '';
                document.getElementById('bl-regex-price').value = blRegex.price_amount || '';

                const b2bSel = config.b2b_selectors || {};
                document.getElementById('b2b-order-container').value = b2bSel.order_settings_container || '';
                document.getElementById('b2b-import-btn').value = b2bSel.import_button || '';
                document.getElementById('b2b-continue-btn').value = b2bSel.continue_button || '';
                document.getElementById('b2b-add-cart-btn').value = b2bSel.add_to_cart_button || '';

                const paymentMethods = config.payment_methods || {};
                document.getElementById('b2b-payment-transfer').value = paymentMethods.bank_transfer_value || '';
                document.getElementById('b2b-payment-cash').value = paymentMethods.cash_on_delivery_value || '';

                const csvConf = config.csv_config || {};
                document.getElementById('csv-delimiter').value = csvConf.delimiter || ',';
                document.getElementById('csv-encoding').value = csvConf.encoding || 'utf-8';
                document.getElementById('csv-headers').value = (csvConf.headers || []).join(', ');

                const timing = config.timing || {};
                document.getElementById('timing-default').value = timing.default_timeout || 10;
                document.getElementById('timing-element').value = timing.element_wait_timeout || 10;
                document.getElementById('timing-click').value = timing.after_click_delay || 1;
                document.getElementById('timing-steps').value = timing.between_steps_delay || 2;
                document.getElementById('timing-startup').value = timing.chrome_startup_delay || 2;

                const dataProc = config.data_processing || {};
                document.getElementById('proc-sku-prefix').value = dataProc.remove_sku_prefix || '';
                document.getElementById('proc-phone-prefix').value = dataProc.remove_phone_prefix || '';
                document.getElementById('proc-building').value = dataProc.default_building_number || '';

                const options = config.options || {};
                document.getElementById('opt-auto-detect').checked = options.auto_detect_chrome_host !== false;
                document.getElementById('opt-use-js').checked = options.use_javascript_for_form_filling !== false;
                document.getElementById('log-level').value = options.log_level || 'INFO';

            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }

        document.getElementById('save-config-btn').addEventListener('click', async () => {
            const config = {
                chrome_path: document.getElementById('chrome-path').value,
                chrome_user_data_dir: document.getElementById('user-data-dir').value,
                chrome_debug_port: parseInt(document.getElementById('debug-port').value),
                baselinker_url: document.getElementById('baselinker-url').value,
                b2b_hendi_url: document.getElementById('b2b-url').value,
                baselinker_keywords: document.getElementById('baselinker-keywords').value.split(',').map(s => s.trim()).filter(s => s),
                b2b_keywords: document.getElementById('b2b-keywords').value.split(',').map(s => s.trim()).filter(s => s),

                baselinker_selectors: {
                    products_container: document.getElementById('bl-products-container').value,
                    total_price: document.getElementById('bl-total-price').value,
                    paid_amount: document.getElementById('bl-paid-amount').value,
                    phone: document.getElementById('bl-phone').value,
                    email: document.getElementById('bl-email').value,
                    b2b_number_field: document.getElementById('bl-b2b-field').value,
                    address: {
                        fullname: document.getElementById('bl-addr-fullname').value,
                        company: document.getElementById('bl-addr-company').value,
                        street: document.getElementById('bl-addr-street').value,
                        city: document.getElementById('bl-addr-city').value,
                        postcode: document.getElementById('bl-addr-postcode').value
                    }
                },

                regex_patterns: {
                    baselinker: {
                        sku: document.getElementById('bl-regex-sku').value,
                        quantity: document.getElementById('bl-regex-quantity').value,
                        price_amount: document.getElementById('bl-regex-price').value
                    },
                    b2b: {
                        order_number: config.regex_patterns?.b2b?.order_number || "Numer:\\s*(\\d+)\\s*\\/\\s*(\\d+)"
                    }
                },

                b2b_selectors: {
                    order_settings_container: document.getElementById('b2b-order-container').value,
                    import_button: document.getElementById('b2b-import-btn').value,
                    import_modal: config.b2b_selectors?.import_modal || '.jsImportProductsModal',
                    file_input: config.b2b_selectors?.file_input || 'input[type="file"]',
                    continue_button: document.getElementById('b2b-continue-btn').value,
                    add_to_cart_button: document.getElementById('b2b-add-cart-btn').value,
                    checkout_button: config.b2b_selectors?.checkout_button || 'button.jsCheckoutButton[type="submit"]',
                    new_address_checkbox: 'new_delivery_address',
                    address_modal: '.jsAddAddressModal',
                    save_address_button: 'button[type="submit"][form="user-address-form"]',
                    address_form_fields: {
                        name: 'address_data[name]',
                        phone: 'address_data[phone]',
                        email: 'address_data[email]',
                        street: 'address_data[street]',
                        street_no: 'address_data[street_no]',
                        street_flat: 'address_data[street_flat]',
                        zip: 'address_data[zip]',
                        city: 'address_data[city]'
                    },
                    payment: {
                        bank_transfer_radio: `input[type="radio"][name="payment_id"][value="${document.getElementById('b2b-payment-transfer').value}"]`,
                        cash_on_delivery_radio: `input[type="radio"][name="payment_id"][value="${document.getElementById('b2b-payment-cash').value}"]`,
                        cash_amount_field: `payment_params[custom_payment_price][${document.getElementById('b2b-payment-cash').value}]`,
                        bank_transfer_label: `label[for="${document.getElementById('b2b-payment-transfer').value}"]`,
                        cash_on_delivery_label: `label[for="${document.getElementById('b2b-payment-cash').value}"]`
                    }
                },

                payment_methods: {
                    bank_transfer_value: document.getElementById('b2b-payment-transfer').value,
                    cash_on_delivery_value: document.getElementById('b2b-payment-cash').value
                },

                csv_config: {
                    delimiter: document.getElementById('csv-delimiter').value,
                    encoding: document.getElementById('csv-encoding').value,
                    headers: document.getElementById('csv-headers').value.split(',').map(s => s.trim()).filter(s => s)
                },

                timing: {
                    default_timeout: parseFloat(document.getElementById('timing-default').value),
                    element_wait_timeout: parseFloat(document.getElementById('timing-element').value),
                    after_click_delay: parseFloat(document.getElementById('timing-click').value),
                    after_file_upload_delay: 1,
                    between_steps_delay: parseFloat(document.getElementById('timing-steps').value),
                    chrome_startup_delay: parseFloat(document.getElementById('timing-startup').value),
                    modal_open_delay: 1,
                    form_submit_delay: 2,
                    payment_section_delay: 2
                },

                data_processing: {
                    remove_sku_prefix: document.getElementById('proc-sku-prefix').value,
                    remove_phone_prefix: document.getElementById('proc-phone-prefix').value,
                    default_building_number: document.getElementById('proc-building').value,
                    skip_b2b_number_values: ["...", ""]
                },

                helper_service: {
                    default_url: "http://127.0.0.1:5001",
                    docker_url: "http://host.docker.internal:5001"
                },

                options: {
                    auto_detect_chrome_host: document.getElementById('opt-auto-detect').checked,
                    use_javascript_for_form_filling: document.getElementById('opt-use-js').checked,
                    preserve_polish_characters: true,
                    log_level: document.getElementById('log-level').value
                }
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Configuration saved successfully!');
                    document.getElementById('config-section').style.display = 'none';
                } else {
                    alert('Failed to save configuration: ' + result.error);
                }
            } catch (error) {
                console.error('Failed to save configuration:', error);
                alert('Failed to save configuration: ' + error.message);
            }
        });

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const chromeStatus = document.getElementById('chrome-status');
                const chromeText = document.getElementById('chrome-status-text');
                if (status.chrome_running) {
                    chromeStatus.className = 'status-indicator status-ok';
                    chromeText.textContent = 'Running';
                } else {
                    chromeStatus.className = 'status-indicator status-error';
                    chromeText.textContent = 'Not running';
                }

                document.getElementById('system-info').textContent = `System: ${status.system}`;

                const baselinkerStatus = document.getElementById('baselinker-status');
                const baselinkerText = document.getElementById('baselinker-status-text');
                if (status.baselinker_open) {
                    baselinkerStatus.className = 'status-indicator status-ok';
                    baselinkerText.textContent = 'Open';
                    document.getElementById('baselinker-title').textContent = status.baselinker_title || '';
                } else {
                    baselinkerStatus.className = 'status-indicator status-error';
                    baselinkerText.textContent = 'Not found';
                    document.getElementById('baselinker-title').textContent = '';
                }

                const b2bStatus = document.getElementById('b2b-status');
                const b2bText = document.getElementById('b2b-status-text');
                if (status.b2b_hendi_open) {
                    b2bStatus.className = 'status-indicator status-ok';
                    b2bText.textContent = 'Open';
                    document.getElementById('b2b-title').textContent = status.b2b_hendi_title || '';
                } else {
                    b2bStatus.className = 'status-indicator status-error';
                    b2bText.textContent = 'Not found';
                    document.getElementById('b2b-title').textContent = '';
                }
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        document.getElementById('launch-chrome-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/launch-chrome', {
                    method: 'POST'
                });
                await response.json();
                setTimeout(updateStatus, 2000);
            } catch (error) {
                console.error('Failed to launch Chrome:', error);
            }
        });

        document.getElementById('refresh-status-btn').addEventListener('click', () => {
            updateStatus();
        });

        document.getElementById('config-btn').addEventListener('click', () => {
            const configSection = document.getElementById('config-section');
            if (configSection.style.display === 'none') {
                configSection.style.display = 'block';
                loadConfig();
            } else {
                configSection.style.display = 'none';
            }
        });

        document.getElementById('cancel-config-btn').addEventListener('click', () => {
            document.getElementById('config-section').style.display = 'none';
        });

        document.getElementById('extract-order-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/extract-order', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    displayOrderData(result);
                    document.getElementById('order-data-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to extract order data:', error);
            }
        });

        document.getElementById('extract-and-import-btn').addEventListener('click', async () => {
            try {
                const extractResponse = await fetch('/api/extract-order', {
                    method: 'POST'
                });
                const extractResult = await extractResponse.json();

                if (!extractResult.success) return;

                const products = extractResult.products || [];
                const address = {
                    company: extractResult.address?.company || '',
                    phone: extractResult.phone || '',
                    address: extractResult.address?.address || '',
                    city: extractResult.address?.city || '',
                    postal_code: extractResult.address?.postal_code || ''
                };
                const email = extractResult.email || '';
                const payment_amount = extractResult.payment_amount || '0';

                if (products.length === 0 || !address.company) return;

                await fetch('/api/complete-order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        products: products,
                        address: address,
                        email: email,
                        payment_amount: payment_amount
                    })
                });

            } catch (error) {
                console.error('Failed to extract and import:', error);
            }
        });

        function displayOrderData(data) {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = '';
            
            if (data.products && data.products.length > 0) {
                data.products.forEach(product => {
                    addProductRow(product.sku, product.quantity);
                });
            }

            document.getElementById('order-phone').value = data.phone || '';
            document.getElementById('order-email').value = data.email || '';
            document.getElementById('order-payment').value = data.payment_amount || '';

            if (data.address) {
                document.getElementById('order-name').value = data.address.name || '';
                document.getElementById('order-company').value = data.address.company || '';
                document.getElementById('order-address').value = data.address.address || '';
                document.getElementById('order-city').value = data.address.city || '';
                document.getElementById('order-postal-code').value = data.address.postal_code || '';
            }
        }

        function addProductRow(sku = '', quantity = '') {
            const tbody = document.getElementById('products-tbody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm product-sku" value="${sku}"></td>
                <td><input type="number" class="form-control form-control-sm product-quantity" value="${quantity}"></td>
                <td><button class="btn btn-sm btn-danger remove-product-btn"><i class="bi bi-trash"></i></button></td>
            `;

            row.querySelector('.remove-product-btn').addEventListener('click', () => {
                row.remove();
            });
        }

        document.getElementById('add-product-btn').addEventListener('click', () => {
            addProductRow();
        });

        document.getElementById('close-order-data-btn').addEventListener('click', () => {
            document.getElementById('order-data-section').style.display = 'none';
        });

        document.getElementById('clear-order-btn').addEventListener('click', () => {
            if (confirm('Are you sure?')) {
                document.getElementById('products-tbody').innerHTML = '';
                document.getElementById('order-phone').value = '';
                document.getElementById('order-email').value = '';
                document.getElementById('order-payment').value = '';
                document.getElementById('order-name').value = '';
                document.getElementById('order-company').value = '';
                document.getElementById('order-address').value = '';
                document.getElementById('order-city').value = '';
                document.getElementById('order-postal-code').value = '';
            }
        });

        document.getElementById('import-to-b2b-btn').addEventListener('click', async () => {
            const products = [];
            document.querySelectorAll('#products-tbody tr').forEach(row => {
                const sku = row.querySelector('.product-sku').value;
                const quantity = row.querySelector('.product-quantity').value;
                if (sku && quantity) {
                    products.push({ sku, quantity });
                }
            });

            if (products.length === 0) {
                alert('No products to import');
                return;
            }

            const address = {
                company: document.getElementById('order-company').value,
                phone: document.getElementById('order-phone').value,
                address: document.getElementById('order-address').value,
                city: document.getElementById('order-city').value,
                postal_code: document.getElementById('order-postal-code').value
            };

            const email = document.getElementById('order-email').value;
            const payment_amount = document.getElementById('order-payment').value;

            if (!address.company || !address.phone || !email) {
                alert('Please fill all required fields');
                return;
            }
            
            try {
                await fetch('/api/complete-order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        products: products,
                        address: address,
                        email: email,
                        payment_amount: payment_amount
                    })
                });
            } catch (error) {
                console.error('Failed to complete order:', error);
            }
        });

        // Auto-refresh
        statusInterval = setInterval(updateStatus, 5000);
        logsInterval = setInterval(updateLogs, 2000);

        // Initial updates
        updateStatus();
        updateLogs();
    </script>
</body>
</html>